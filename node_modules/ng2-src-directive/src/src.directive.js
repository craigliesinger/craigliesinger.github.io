"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var core_1 = require('angular2/core');
var http_1 = require('angular2/http');
var Observable_1 = require('rxjs/Observable');
var Subject_1 = require('rxjs/Subject');
require('rxjs/add/observable/empty');
require('rxjs/add/observable/timer');
require('rxjs/add/operator/map');
require('rxjs/add/operator/filter');
require('rxjs/add/operator/distinctUntilChanged');
require('rxjs/add/operator/debounce');
require('rxjs/add/operator/do');
require('rxjs/add/operator/retry');
require('rxjs/add/operator/catch');
require('rxjs/add/operator/switchMap');
exports.SourceDebounceTime = 300;
var SrcDirective = (function () {
    function SrcDirective(_element, _viewManager, _http, _renderer, _sourceDebounceTime) {
        this._element = _element;
        this._viewManager = _viewManager;
        this._http = _http;
        this._renderer = _renderer;
        this._sourceDebounceTime = _sourceDebounceTime;
        this._debounceTime = 300;
        this.sourceChanged = new Subject_1.Subject();
        this._firstRequest = true;
    }
    Object.defineProperty(SrcDirective.prototype, "src", {
        set: function (source) {
            this._src = source;
            this.sourceChanged.next(source);
        },
        enumerable: true,
        configurable: true
    });
    SrcDirective.prototype.ngOnInit = function () {
        this.host = this._viewManager.getComponent(this._element);
        if (this.host === this)
            this.host = this._element;
        if (this._sourceDebounceTime)
            this.debounceTime = this._sourceDebounceTime;
        this._handleSourceChanges();
        if (this._src)
            this.sourceChanged.next(this._src);
    };
    Object.defineProperty(SrcDirective.prototype, "debounceTime", {
        get: function () {
            return this._debounceTime;
        },
        /**
         * Set the amount of time in ms to wait before processing changes to the src input.
         *
         * This can prevent unnecessary http requests. The default is 300ms.
         */
        set: function (time) {
            var parsed = parseInt(time, 10);
            if (!isNaN(parsed) && parsed >= 0) {
                this._debounceTime = parsed;
            }
        },
        enumerable: true,
        configurable: true
    });
    SrcDirective.prototype._handleSourceChanges = function () {
        var _this = this;
        this._subscription = this.sourceChanged
            .do(function (source) { if (_this.host.sourceChanged)
            _this.host.sourceChanged(source); })
            .filter(function (source) { return _this._emptySources(source); })
            .map(function (source) { return _this._addExtensionMatches(source); })
            .filter(function (req) { return _this._nonFiles(req); })
            .distinctUntilChanged()
            .do(function (req) { if (_this.host.sourceLoading)
            _this.host.sourceLoading(req.source); })
            .debounce(function () { return Observable_1.Observable.timer(_this._firstRequest ? 0 : _this.debounceTime); })
            .do(function () { return _this._firstRequest = false; })
            .switchMap(function (req) { return _this._fetchSrc(req); })
            .catch(function (error) {
            if (_this.host.sourceError)
                _this.host.sourceError(error);
            console.error(error);
            return Observable_1.Observable.empty();
        })
            .subscribe(function (res) {
            if (_this.host.sourceReceived) {
                _this.host.sourceReceived(res);
            }
            else {
                _this._renderer.setElementProperty(_this._element.nativeElement, 'innerHTML', res.text());
            }
        }, function (error) {
            if (_this.host.sourceError)
                _this.host.sourceError(error);
            console.error(error);
        });
    };
    SrcDirective.prototype.ngOnDestroy = function () {
        this._subscription.dispose();
    };
    SrcDirective.prototype._emptySources = function (source) {
        return !(source === undefined || source === null || source === '');
    };
    SrcDirective.prototype._addExtensionMatches = function (source) {
        return {
            source: source,
            extMatches: source.match(/\.(\w+)$/)
        };
    };
    SrcDirective.prototype._nonFiles = function (req) {
        if (!req.extMatches) {
            if (req.source && req.source.length > 0) {
                if (this.host.sourceError) {
                    this.host.sourceError({ message: req.source + " is not a file." });
                }
            }
            else {
                if (this.host.sourceError) {
                    this.host.sourceError({ message: "No source file given." });
                }
            }
            return false;
        }
        return true;
    };
    SrcDirective.prototype._fetchSrc = function (req) {
        var _this = this;
        return this._http.get(req.source)
            .catch(function (error) {
            if (_this.host.sourceError) {
                _this.host.sourceError({ message: req.source + " not found." });
            }
            return Observable_1.Observable.empty();
        });
    };
    __decorate([
        core_1.Input(), 
        __metadata('design:type', String), 
        __metadata('design:paramtypes', [String])
    ], SrcDirective.prototype, "src", null);
    __decorate([
        core_1.Input(), 
        __metadata('design:type', Object), 
        __metadata('design:paramtypes', [Object])
    ], SrcDirective.prototype, "debounceTime", null);
    SrcDirective = __decorate([
        core_1.Directive({ selector: '[src]' }),
        __param(4, core_1.Optional()),
        __param(4, core_1.Inject(exports.SourceDebounceTime)), 
        __metadata('design:paramtypes', [core_1.ElementRef, core_1.AppViewManager, http_1.Http, core_1.Renderer, Number])
    ], SrcDirective);
    return SrcDirective;
}());
exports.SrcDirective = SrcDirective;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3JjLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNyYy5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBLHFCQVVPLGVBQWUsQ0FBQyxDQUFBO0FBQ3ZCLHFCQUE2QixlQUFlLENBQUMsQ0FBQTtBQUU3QywyQkFBeUIsaUJBQWlCLENBQUMsQ0FBQTtBQUMzQyx3QkFBc0IsY0FBYyxDQUFDLENBQUE7QUFDckMsUUFBTywyQkFBMkIsQ0FBQyxDQUFBO0FBQ25DLFFBQU8sMkJBQTJCLENBQUMsQ0FBQTtBQUNuQyxRQUFPLHVCQUF1QixDQUFDLENBQUE7QUFDL0IsUUFBTywwQkFBMEIsQ0FBQyxDQUFBO0FBQ2xDLFFBQU8sd0NBQXdDLENBQUMsQ0FBQTtBQUNoRCxRQUFPLDRCQUE0QixDQUFDLENBQUE7QUFDcEMsUUFBTyxzQkFBc0IsQ0FBQyxDQUFBO0FBQzlCLFFBQU8seUJBQXlCLENBQUMsQ0FBQTtBQUNqQyxRQUFPLHlCQUF5QixDQUFDLENBQUE7QUFDakMsUUFBTyw2QkFBNkIsQ0FBQyxDQUFBO0FBRTFCLDBCQUFrQixHQUFXLEdBQUcsQ0FBQztBQUc1QztJQVNFLHNCQUNVLFFBQW9CLEVBQ3BCLFlBQTRCLEVBQzVCLEtBQVcsRUFDWCxTQUFtQixFQUNxQixtQkFBMkI7UUFKbkUsYUFBUSxHQUFSLFFBQVEsQ0FBWTtRQUNwQixpQkFBWSxHQUFaLFlBQVksQ0FBZ0I7UUFDNUIsVUFBSyxHQUFMLEtBQUssQ0FBTTtRQUNYLGNBQVMsR0FBVCxTQUFTLENBQVU7UUFDcUIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFRO1FBeUI3RSxrQkFBYSxHQUFXLEdBQUcsQ0FBQztRQUU1QixrQkFBYSxHQUFvQixJQUFJLGlCQUFPLEVBQUUsQ0FBQztRQUUvQyxrQkFBYSxHQUFZLElBQUksQ0FBQztJQTdCbUQsQ0FBQztJQVZ6RSxzQkFBSSw2QkFBRzthQUFQLFVBQVEsTUFBYztZQUM3QixJQUFJLENB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QUMsRUFBQyxPQUFPLEVBQUssR0FBRyxDQUFDLE1BQU0sZ0JBQWEsRUFBQyxDQUFDLENBQUM7WUFDL0QsQ0FBQztZQUNELE1BQU0sQ0FBQyx1QkFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzVCLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLENBQUM7SUFoSEQ7UUFBQyxZQUFLLEVBQUU7OzsyQ0FBQTtJQTBCUjtRQUFDLFlBQUssRUFBRTs7O29EQUFBO0lBL0JWO1FBQUMsZ0JBQVMsQ0FBQyxFQUFDLFFBQVEsRUFBRSxPQUFPLEVBQUMsQ0FBQzttQkFlMUIsZUFBUSxFQUFFO21CQUFFLGFBQU0sQ0FBQywwQkFBa0IsQ0FBQzs7b0JBZlo7SUF1SC9CLG1CQUFDO0FBQUQsQ0FBQyxBQXRIRCxJQXNIQztBQXRIWSxvQkFBWSxlQXNIeEIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFwcFZpZXdNYW5hZ2VyLFxuICBEaXJlY3RpdmUsXG4gIEVsZW1lbnRSZWYsXG4gIEluamVjdCxcbiAgSW5wdXQsXG4gIE9uSW5pdCxcbiAgT25EZXN0cm95LFxuICBPcHRpb25hbCxcbiAgUmVuZGVyZXJcbn0gZnJvbSAnYW5ndWxhcjIvY29yZSc7XG5pbXBvcnQge0h0dHAsIFJlc3BvbnNlfSBmcm9tICdhbmd1bGFyMi9odHRwJztcbmltcG9ydCB7U291cmNhYmxlfSBmcm9tICcuL3NvdXJjYWJsZSc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQge1N1YmplY3R9IGZyb20gJ3J4anMvU3ViamVjdCc7XG5pbXBvcnQgJ3J4anMvYWRkL29ic2VydmFibGUvZW1wdHknO1xuaW1wb3J0ICdyeGpzL2FkZC9vYnNlcnZhYmxlL3RpbWVyJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvbWFwJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvZmlsdGVyJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvZGlzdGluY3RVbnRpbENoYW5nZWQnO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9kZWJvdW5jZSc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL2RvJztcbmltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvcmV0cnknO1xuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9jYXRjaCc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL3N3aXRjaE1hcCc7XG5cbmV4cG9ydCB2YXIgU291cmNlRGVib3VuY2VUaW1lOiBudW1iZXIgPSAzMDA7XG5cbkBEaXJlY3RpdmUoe3NlbGVjdG9yOiAnW3NyY10nfSlcbmV4cG9ydCBjbGFzcyBTcmNEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG5cbiAgaG9zdDogU291cmNhYmxlO1xuICBfc3JjOiBzdHJpbmc7XG4gIEBJbnB1dCgpIHNldCBzcmMoc291cmNlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9zcmMgPSBzb3VyY2U7XG4gICAgdGhpcy5zb3VyY2VDaGFuZ2VkLm5leHQoc291cmNlKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgX2VsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBfdmlld01hbmFnZXI6IEFwcFZpZXdNYW5hZ2VyLFxuICAgIHByaXZhdGUgX2h0dHA6IEh0dHAsXG4gICAgcHJpdmF0ZSBfcmVuZGVyZXI6IFJlbmRlcmVyLFxuICAgIEBPcHRpb25hbCgpIEBJbmplY3QoU291cmNlRGVib3VuY2VUaW1lKSBwcml2YXRlIF9zb3VyY2VEZWJvdW5jZVRpbWU6IG51bWJlcikgeyB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5ob3N0ID0gPFNvdXJjYWJsZT50aGlzLl92aWV3TWFuYWdlci5nZXRDb21wb25lbnQodGhpcy5fZWxlbWVudCk7XG4gICAgaWYgKDxhbnk+dGhpcy5ob3N0ID09PSB0aGlzKSB0aGlzLmhvc3QgPSB0aGlzLl9lbGVtZW50O1xuICAgIGlmICh0aGlzLl9zb3VyY2VEZWJvdW5jZVRpbWUpIHRoaXMuZGVib3VuY2VUaW1lID0gdGhpcy5fc291cmNlRGVib3VuY2VUaW1lO1xuXG4gICAgdGhpcy5faGFuZGxlU291cmNlQ2hhbmdlcygpO1xuICAgIGlmICh0aGlzLl9zcmMpIHRoaXMuc291cmNlQ2hhbmdlZC5uZXh0KHRoaXMuX3NyYyk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSBhbW91bnQgb2YgdGltZSBpbiBtcyB0byB3YWl0IGJlZm9yZSBwcm9jZXNzaW5nIGNoYW5nZXMgdG8gdGhlIHNyYyBpbnB1dC5cbiAgICpcbiAgICogVGhpcyBjYW4gcHJldmVudCB1bm5lY2Vzc2FyeSBodHRwIHJlcXVlc3RzLiBUaGUgZGVmYXVsdCBpcyAzMDBtcy5cbiAgICovXG4gIEBJbnB1dCgpIHNldCBkZWJvdW5jZVRpbWUodGltZTogYW55KSB7XG4gICAgbGV0IHBhcnNlZCA9IHBhcnNlSW50KHRpbWUsIDEwKTtcbiAgICBpZiAoIWlzTmFOKHBhcnNlZCkgJiYgcGFyc2VkID49IDApIHtcbiAgICAgIHRoaXMuX2RlYm91bmNlVGltZSA9IHBhcnNlZDtcbiAgICB9XG4gIH1cbiAgZ2V0IGRlYm91bmNlVGltZSgpOiBudW1iZXIgfCBhbnkge1xuICAgIHJldHVybiB0aGlzLl9kZWJvdW5jZVRpbWU7XG4gIH1cbiAgX2RlYm91bmNlVGltZTogbnVtYmVyID0gMzAwO1xuXG4gIHNvdXJjZUNoYW5nZWQ6IFN1YmplY3Q8c3RyaW5nPiA9IG5ldyBTdWJqZWN0KCk7XG4gIF9zdWJzY3JpcHRpb247XG4gIF9maXJzdFJlcXVlc3Q6IGJvb2xlYW4gPSB0cnVlO1xuXG4gIF9oYW5kbGVTb3VyY2VDaGFuZ2VzKCkge1xuICAgICB0aGlzLl9zdWJzY3JpcHRpb24gPSB0aGlzLnNvdXJjZUNoYW5nZWRcbiAgICAgIC5kbyhzb3VyY2UgPT4geyBpZiAodGhpcy5ob3N0LnNvdXJjZUNoYW5nZWQpIHRoaXMuaG9zdC5zb3VyY2VDaGFuZ2VkKHNvdXJjZSk7IH0pXG4gICAgICAuZmlsdGVyKHNvdXJjZSA9PiB7IHJldHVybiB0aGlzLl9lbXB0eVNvdXJjZXMoc291cmNlKTsgfSlcbiAgICAgIC5tYXAoc291cmNlID0+IHsgcmV0dXJuIHRoaXMuX2FkZEV4dGVuc2lvbk1hdGNoZXMoc291cmNlKTsgfSlcbiAgICAgIC5maWx0ZXIocmVxID0+IHsgcmV0dXJuIHRoaXMuX25vbkZpbGVzKHJlcSk7IH0pXG4gICAgICAuZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICAgLmRvKHJlcSA9PiB7IGlmICh0aGlzLmhvc3Quc291cmNlTG9hZGluZykgdGhpcy5ob3N0LnNvdXJjZUxvYWRpbmcocmVxLnNvdXJjZSk7IH0pXG4gICAgICAuZGVib3VuY2UoKCkgPT4gT2JzZXJ2YWJsZS50aW1lcih0aGlzLl9maXJzdFJlcXVlc3QgPyAwIDogdGhpcy5kZWJvdW5jZVRpbWUpKVxuICAgICAgLmRvKCgpID0+IHRoaXMuX2ZpcnN0UmVxdWVzdCA9IGZhbHNlKVxuICAgICAgLnN3aXRjaE1hcChyZXEgPT4geyByZXR1cm4gdGhpcy5fZmV0Y2hTcmMocmVxKTsgfSlcbiAgICAgIC5jYXRjaCgoZXJyb3IpID0+IHtcbiAgICAgICAgaWYgKHRoaXMuaG9zdC5zb3VyY2VFcnJvcikgdGhpcy5ob3N0LnNvdXJjZUVycm9yKGVycm9yKTtcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnJvcik7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmVtcHR5KCk7XG4gICAgICB9KVxuICAgICAgLnN1YnNjcmliZShcbiAgICAgICAgKHJlczogUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5ob3N0LnNvdXJjZVJlY2VpdmVkKSB7XG4gICAgICAgICAgICB0aGlzLmhvc3Quc291cmNlUmVjZWl2ZWQocmVzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5fcmVuZGVyZXIuc2V0RWxlbWVudFByb3BlcnR5KFxuICAgICAgICAgICAgICB0aGlzLl9lbGVtZW50Lm5hdGl2ZUVsZW1lbnQsICdpbm5lckhUTUwnLCByZXMudGV4dCgpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICBpZiAodGhpcy5ob3N0LnNvdXJjZUVycm9yKSB0aGlzLmhvc3Quc291cmNlRXJyb3IoZXJyb3IpO1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9uLmRpc3Bvc2UoKTtcbiAgfVxuXG4gIF9lbXB0eVNvdXJjZXMoc291cmNlKSB7XG4gICAgcmV0dXJuICEoc291cmNlID09PSB1bmRlZmluZWQgfHwgc291cmNlID09PSBudWxsIHx8IHNvdXJjZSA9PT0gJycpO1xuICB9XG5cbiAgX2FkZEV4dGVuc2lvbk1hdGNoZXMoc291cmNlKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNvdXJjZTogc291cmNlLFxuICAgICAgZXh0TWF0Y2hlczogc291cmNlLm1hdGNoKC9cXC4oXFx3KykkLylcbiAgICB9O1xuICB9XG5cbiAgX25vbkZpbGVzKHJlcSkge1xuICAgIGlmICghcmVxLmV4dE1hdGNoZXMpIHtcbiAgICAgIGlmIChyZXEuc291cmNlICYmIHJlcS5zb3VyY2UubGVuZ3RoID4gMCkge1xuICAgICAgICBpZiAodGhpcy5ob3N0LnNvdXJjZUVycm9yKSB7XG4gICAgICAgICAgdGhpcy5ob3N0LnNvdXJjZUVycm9yKHttZXNzYWdlOiBgJHtyZXEuc291cmNlfSBpcyBub3QgYSBmaWxlLmB9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKHRoaXMuaG9zdC5zb3VyY2VFcnJvcikge1xuICAgICAgICAgIHRoaXMuaG9zdC5zb3VyY2VFcnJvcih7bWVzc2FnZTogYE5vIHNvdXJjZSBmaWxlIGdpdmVuLmB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIF9mZXRjaFNyYyhyZXEpIHtcbiAgICByZXR1cm4gdGhpcy5faHR0cC5nZXQocmVxLnNvdXJjZSlcbiAgICAgICAgICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAodGhpcy5ob3N0LnNvdXJjZUVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaG9zdC5zb3VyY2VFcnJvcih7bWVzc2FnZTogYCR7cmVxLnNvdXJjZX0gbm90IGZvdW5kLmB9KTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmVtcHR5KCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gIH1cblxufVxuIl19